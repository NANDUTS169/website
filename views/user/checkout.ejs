<%- include('../../views/partials/user/header')%>

	<link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500,600,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Rokkitt:100,300,400,700" rel="stylesheet">
	
	<!-- Animate.css -->
	<link rel="stylesheet" href="css/animate.css">
	<!-- Icomoon Icon Fonts-->
	<link rel="stylesheet" href="css/icomoon.css">
	<!-- Ion Icon Fonts-->
	<link rel="stylesheet" href="css/ionicons.min.css">
	<!-- Bootstrap  -->
	<link rel="stylesheet" href="css/bootstrap.min.css">

	<!-- Magnific Popup -->
	<link rel="stylesheet" href="css/magnific-popup.css">

	<!-- Flexslider  -->
	<link rel="stylesheet" href="css/flexslider.css">

	<!-- Owl Carousel -->
	<link rel="stylesheet" href="css/owl.carousel.min.css">
	<link rel="stylesheet" href="css/owl.theme.default.min.css">
	
	<!-- Date Picker -->
	<link rel="stylesheet" href="css/bootstrap-datepicker.css">
	<!-- Flaticons  -->
	<link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">

	<!-- Theme style  -->
	<link rel="stylesheet" href="css/style.css">

	</head>
	<body>
		
	<div class="colorlib-loader"></div>

	<div id="page">
		<div class="breadcrumbs">
			<div class="container">
				<div class="row">
					<div class="col">
						<p class="bread"><span><a href="index.html">Home</a></span> / <span>Checkout</span></p>
					</div>
				</div>
			</div>
		</div>


		<div class="colorlib-product">
			<div class="container">
				<div class="row row-pb-lg">
					<div class="col-sm-10 offset-md-1">
						<div class="process-wrap">
							<div class="process text-center active">
								<p><span>01</span></p>
								<h3>Shopping Cart</h3>
							</div>
							<div class="process text-center active">
								<p><span>02</span></p>
								<h3>Checkout</h3>
							</div>
							<div class="process text-center">
								<p><span>03</span></p>
								<h3>Order Complete</h3>
							</div>
						</div>
					</div>
				</div>
<div class="row">
	<div class="col-lg-8">
		<div class="card">
			<div class="card-header">
				<h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>My Addresses</h5>
			</div>
			<div class="card-body">
				<div id="addressList">
					<% addresses.filter(addr => addr.isActive).forEach(function(addr) { %>
						<div class="address-item border rounded p-3 mb-3 bg-light">
							<div class="d-flex justify-content-between align-items-start">
								<div>
									<h6 class="mb-1">
										<i class="fas <%= addr.addressType === 'home' ? 'fa-home' : addr.addressType === 'work' ? 'fa-building' : 'fa-map-marker-alt' %> me-2"></i>
										<%= addr.addressType.charAt(0).toUpperCase() + addr.addressType.slice(1) %> Address
									</h6>
									<p class="mb-0">
										<%= addr.fullName %><br>
										<%= addr.streetAddress %>, <%= addr.city %><br>
										<%= addr.state %> - <%= addr.pincode %><br>
										<%= addr.country %><br>
										Phone: <%= addr.phone %><br>
									</p>
								</div>
								<div class="mt-2">
									<button class="btn btn-sm btn-outline-primary" onclick="openEditAddress('<%= addr._id %>')">Edit</button>
									<button class="btn btn-sm btn-outline-danger" onclick="deleteAddress('<%= addr._id %>')">Remove</button>
								</div>
							</div>
						</div>
					<% }) %>
				</div>
				<button class="btn btn-outline-primary w-100 mt-3" data-bs-toggle="modal" data-bs-target="#addressModal">
					<i class="fas fa-plus me-2"></i>Add New Address
				</button>
			</div>
		</div>
	</div>
	<div class="col-lg-4">
		<div class="card mb-3">
			<div class="card-body">
				<div class="cart-detail">
					<h2>Cart Total</h2>
					<ul>
						<li>
							<span>Subtotal</span> <span>$100.00</span>
							<ul>
								<li><span>1 x Product Name</span> <span>$99.00</span></li>
								<li><span>1 x Product Name</span> <span>$78.00</span></li>
							</ul>
						</li>
						<li><span>Shipping</span> <span>$0.00</span></li>
						<li><span>Order Total</span> <span>$180.00</span></li>
					</ul>
				</div>
			</div>
		</div>

		<div class="card mb-3">
			<div class="card-body">
				<div class="cart-detail">
					<h2>Payment Method</h2>
					<div class="form-group">
						<div class="radio">
							<label><input type="radio" name="optradio"> Direct Bank Transfer</label>
						</div>
					</div>
					<div class="form-group">
						<div class="radio">
							<label><input type="radio" name="optradio"> Check Payment</label>
						</div>
					</div>
					<div class="form-group">
						<div class="radio">
							<label><input type="radio" name="optradio"> Paypal</label>
						</div>
					</div>
					<div class="form-group">
						<div class="checkbox">
							<label><input type="checkbox" value=""> I have read and accept the terms and conditions</label>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="card">
			<div class="card-body text-center">
				<a href="/order" class="btn btn-primary w-100">Place an order</a>
			</div>
		</div>
	</div>
</div>
		</div>
	</div>


	    <!-- Address Modal -->
    <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addressModalLabel">Add New Address</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addressForm">
    <div class="row g-3">
        <div class="col-md-6">
            <label for="addressType" class="form-label">Address Type</label>
            <select class="form-select" id="addressType" name="addressType" required>
                <option value="">Select Type</option>
                <option value="home">Home Address</option>
                <option value="work">Work Address</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="fullName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="fullName" name="fullName" placeholder="Enter full name" required>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-12">
            <label for="streetAddress" class="form-label">Street Address</label>
            <input type="text" class="form-control" id="streetAddress" name="streetAddress" placeholder="Enter street address" required>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <label for="city" class="form-label">City</label>
            <input type="text" class="form-control" id="city" name="city" placeholder="Enter city" required>
        </div>
        <div class="col-md-3">
            <label for="state" class="form-label">State</label>
            <input type="text" class="form-control" id="state" name="state" placeholder="State" required>
        </div>
        <div class="col-md-3">
            <label for="pincode" class="form-label">Pincode</label>
            <input type="text" class="form-control" id="pincode" name="pincode" placeholder="pincode" required>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-6">
            <label for="country" class="form-label">Country</label>
            <select class="form-select" id="country" name="country" required>
                <option value="">Select Country</option>
                <option value="India">India</option>
                <option value="US">United States</option>
                <option value="CA">Canada</option>
                <option value="UK">United Kingdom</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="phone" name="phone" placeholder="Enter phone number" required>
        </div>
    </div>

    <div class="row g-3 mt-2">
        <div class="col-12">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="defaultAddress" name="defaultAddress">
                <label class="form-check-label" for="defaultAddress">
                    Set as default address
                </label>
            </div>
        </div>
    </div>
</form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAddress()">Save Address</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Address Modal  -->
     <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editAddressForm">
          <!-- Hidden field for addressId -->
          <input type="hidden" id="editAddressId" name="addressId">

          <div class="row g-3">
            <div class="col-md-6">
              <label for="editAddressType" class="form-label">Address Type</label>
              <select class="form-select" id="editAddressType" name="addressType" required>
                <option value="" disabled selected>Select Type</option>
                <option value="home">Home Address</option>
                <option value="work">Work Address</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editFullName" class="form-label">Full Name</label>
              <input type="text" class="form-control" id="editFullName" name="fullName" required>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12">
              <label for="editStreetAddress" class="form-label">Street Address</label>
              <input type="text" class="form-control" id="editStreetAddress" name="streetAddress" required>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="editCity" class="form-label">City</label>
              <input type="text" class="form-control" id="editCity" name="city" required>
            </div>
            <div class="col-md-3">
              <label for="editState" class="form-label">State</label>
              <input type="text" class="form-control" id="editState" name="state" required>
            </div>
            <div class="col-md-3">
              <label for="editPincode" class="form-label">Pincode</label>
              <input type="text" class="form-control" id="editPincode" name="pincode" required>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label for="editCountry" class="form-label">Country</label>
              <select class="form-select" id="editCountry" name="country" required>
                <option value="">Select Country</option>
                <option value="India">India</option>
                <option value="US">United States</option>
                <option value="CA">Canada</option>
                <option value="UK">United Kingdom</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="editPhone" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="editPhone" name="phone" required>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editDefaultAddress" name="defaultAddress">
                <label class="form-check-label" for="editDefaultAddress">
                  Set as default address
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateAddress()">Update Address</button>
      </div>
    </div>
  </div>
	</div>

	<div class="gototop js-top">
		<a href="#" class="js-gotop"><i class="ion-ios-arrow-up"></i></a>
	</div>
	
	<!-- jQuery -->
	<script src="js/jquery.min.js"></script>
   <!-- popper -->
   <script src="js/popper.min.js"></script>
   <!-- bootstrap 4.1 -->
   <script src="js/bootstrap.min.js"></script>
   <!-- jQuery easing -->
   <script src="js/jquery.easing.1.3.js"></script>
	<!-- Waypoints -->
	<script src="js/jquery.waypoints.min.js"></script>
	<!-- Flexslider -->
	<script src="js/jquery.flexslider-min.js"></script>
	<!-- Owl carousel -->
	<script src="js/owl.carousel.min.js"></script>
	<!-- Magnific Popup -->
	<script src="js/jquery.magnific-popup.min.js"></script>
	<script src="js/magnific-popup-options.js"></script>
	<!-- Date Picker -->
	<script src="js/bootstrap-datepicker.js"></script>
	<!-- Stellar Parallax -->
	<script src="js/jquery.stellar.min.js"></script>
	<!-- Main -->
	<script src="js/main.js"></script>

	    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    

	<script>

		async function saveAddress() {
    const form = document.getElementById("addressForm");
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // checkbox handling
    data.defaultAddress = formData.get("defaultAddress") ? true : false;

    // ✅ frontend validation
    for (const [key, value] of Object.entries(data)) {
        if (key !== "defaultAddress" && (!value || value.trim() === "")) {
            alert(`${key} is required`);
            return;
        }
    }

    try {
        const res = await fetch("/addresses", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        const result = await res.json();

        if (result.success) {
            // close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById("addressModal"));
            modal.hide();

            // clear form
            form.reset();

            // refresh UI
            updateAddressList(result.addresses.filter(a => a.isActive));
        } else {
            alert(result.message || "Failed to add address");
        }
    } catch (err) {
        console.error("❌ Error saving address:", err);
        alert("Something went wrong. Try again!");
    }
}



// Update DOM dynamically
function updateAddressList(addresses) {
    const list = document.getElementById("addressList");
    list.innerHTML = "";

    if (addresses.length === 0) {
        list.innerHTML = `<p class="text-muted">No saved addresses. Add one below.</p>`;
        return;
    }

    addresses.forEach(addr => {
        const div = document.createElement("div");
        div.className = "address-item border rounded p-3 mb-3 bg-light";
        div.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1">
                        <i class="fas ${addr.addressType === 'home' ? 'fa-home' : addr.addressType === 'work' ? 'fa-building' : 'fa-map-marker-alt'} me-2"></i>
                        ${addr.addressType.charAt(0).toUpperCase() + addr.addressType.slice(1)} Address
                    </h6>
                    <p class="mb-0">
                        ${addr.fullName}<br>
                        ${addr.streetAddress}, ${addr.city}<br>
                        ${addr.state} - ${addr.pincode}<br>
                        ${addr.country}<br>
                        Phone: ${addr.phone}
                    </p>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="openEditAddress('${addr._id}')">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAddress('${addr._id}')">Remove</button>
                </div>
            </div>
        `;
        list.appendChild(div);
    });
}

async function deleteAddress(addressId) {
    if (!confirm("Are you sure you want to delete this address?")) return;

    try {
        const response = await fetch(`/addresses/${addressId}/soft-delete`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            }
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();

        console.log("Data",data)

        if (data.success) {
            updateAddressList(data.addresses.filter(a => a.isActive))
        } else {
            alert(data.message || "Delete failed");
        }
    } catch (err) {
        console.error("Delete error:", err);
        alert("Something went wrong. Check console.");
    }
}



let editingAddressId = null; // null = add mode, value = edit mode

// Open modal for ADD
function openAddAddress() {
    editingAddressId = null;
    document.getElementById("addressModalLabel").innerText = "Add New Address";
    document.getElementById("addressForm").reset();
    document.getElementById("defaultAddress").checked = false;
    const modal = new bootstrap.Modal(document.getElementById("addressModal"));
    modal.show();
}

		async function openEditAddress(addressId) {
    editingAddressId = addressId;
    document.getElementById("editAddressModalLabel").innerText = "Edit Address";


    try {
        // fetch details from DOM (already rendered by EJS)
        const card = document.querySelector(`button[onclick="openEditAddress('${addressId}')"]`).closest(".address-item");
        const lines = card.querySelector("p").innerHTML.split("<br>");

        // hidden id
        document.getElementById("editAddressId").value = addressId;

        // fill fields
        document.getElementById("editFullName").value = lines[0].trim();
        document.getElementById("editStreetAddress").value = lines[1].split(",")[0].trim();
        document.getElementById("editCity").value = lines[1].split(",")[1].trim();
        document.getElementById("editState").value = lines[2].split("-")[0].trim();
        document.getElementById("editPincode").value = lines[2].split("-")[1].trim();
        document.getElementById("editCountry").value = lines[3].trim();
        document.getElementById("editPhone").value = lines[4].replace("Phone:", "").trim();

        // open modal
        const modal = new bootstrap.Modal(document.getElementById("editAddressModal"));
        modal.show();
    } catch (err) {
        console.error("Error pre-filling edit form:", err);
        alert("Could not load address for editing");
    }
}


async function updateAddress() {
  const addressId = document.getElementById("editAddressId").value;

  // collect values from modal fields
  const data = {
    addressType: document.getElementById("editAddressType").value || "home",
    fullName: document.getElementById("editFullName").value,
    streetAddress: document.getElementById("editStreetAddress").value,
    city: document.getElementById("editCity").value,
    state: document.getElementById("editState").value,
    pincode: document.getElementById("editPincode").value,
    country: document.getElementById("editCountry").value,
    phone: document.getElementById("editPhone").value,
    defaultAddress: document.getElementById("editDefaultAddress").checked
  };

  try {
    const res = await fetch(`/addresses/${addressId}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    });

    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }

    const result = await res.json();
    console.log(" Address updated:", result);

    updateAddressList(result.addresses.filter(a => a.isActive))

    // close modal
    const modalEl = document.getElementById("editAddressModal");
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();

  } catch (err) {
    console.error(" Error updating address:", err);
    alert("Failed to update address. Please try again.");
  }
}

	</script>
	</body>

<%-include('../../views/partials/user/footer')%>

