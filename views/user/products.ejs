<%- include("../../views/partials/user/header") %>
<style>
  html, body { overflow-x: hidden !important; }
  .row { margin-left: 0; margin-right: 0; }
  .container-fluid, .container { padding-left: 15px; padding-right: 15px; }
  .product-entry { position: relative; transition: transform 0.2s ease; }
  .product-entry:hover { transform: scale(1.03); }
  .prod-img img { max-height: 300px; object-fit: cover; width: 100%; }
  .wishlist-btn { position: absolute; top: 10px; right: 10px; z-index: 100; background: transparent; border: 0; }
</style>

<div class="colorlib-product">
  <div class="container">
    <div class="row">
      <div class="col-sm-8 offset-sm-2 text-center colorlib-heading">
        <h2>All Products</h2>
      </div>
    </div>

    <div class="row">
      <% if (products && products.length > 0) { %>
        <% products.forEach(product => { 
             const unavailable = (product.isBlocked === true) || (product.status !== "Available") || (product.quantity <= 0);
        %>
          <div class="col-lg-3 col-md-4 col-sm-6 mb-4 text-center d-flex">
            <div class="product-entry border position-relative w-100">

              <!-- Product Image -->
              <a href="/productdetails/<%= product._id %>" class="prod-img d-block">
                <img src="/uploads/product-images/<%= product.productImage[0] %>" class="img-fluid" alt="<%= product.productName %>">
              </a>

              <!-- Wishlist Button (POST via fetch) -->
              <button class="wishlist-btn" title="Add to wishlist"
                      onclick="addToWishlist('<%= product._id %>')">
                <i class="icon-heart" style="font-size: 20px; color: red;"></i>
              </button>

              <!-- Product Info -->
              <div class="desc">
                <h2><a href="/productdetails/<%= product._id %>"><%= product.productName %></a></h2>
                <span class="price">â‚¹ <%= product.salePrice %></span>

                <% if (unavailable) { %>
                  <p><button class="btn btn-sm btn-secondary mt-2" disabled>Unavailable</button></p>
                <% } else { %>
                  <p><button class="btn btn-sm btn-primary mt-2" onclick="addToCart('<%= product._id %>')">Add to Cart</button></p>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="col-md-12 text-center">
          <p>No products available right now.</p>
        </div>
      <% } %>
    </div>

    <!-- Pagination (Optional) -->
    <div class="row">
      <div class="col-md-12 text-center">
        <ul class="pagination">
          <li class="page-item"><a class="page-link" href="#">Prev</a></li>
          <li class="page-item active"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">2</a></li>
          <li class="page-item"><a class="page-link" href="#">Next</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
  async function addToCart(productId) {
    try {
      const res = await fetch("/addToCart", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId, quantity: 1 })
      });

      const data = await res.json().catch(() => ({}));
      if (res.status === 401) {
        window.location = "/login?next=" + encodeURIComponent(window.location.pathname + window.location.search);
        return;
      }
      if (!res.ok) {
        alert(data.message || "Failed to add to cart.");
        return;
      }
      alert(data.message || "Product added to cart!");
      // optionally refresh cart count / reload
      // location.reload();
    } catch (err) {
      console.error(err);
      alert("Something went wrong!");
    }
  }

  async function addToWishlist(productId) {
    try {
      const res = await fetch("/wishlist/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId })
      });

      const data = await res.json().catch(() => ({}));
      if (res.status === 401) {
        window.location = "/login?next=" + encodeURIComponent(window.location.pathname + window.location.search);
        return;
      }
      if (!res.ok) {
        alert(data.message || "Failed to add to wishlist.");
        return;
      }
      alert(data.message || "Added to wishlist!");
    } catch (err) {
      console.error(err);
      alert("Error while adding to wishlist");
    }
  }
</script>

<%- include("../../views/partials/user/footer") %>
